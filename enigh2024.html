<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de An√°lisis Socioecon√≥mico ENIGH Automatizado</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .company-branding {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
        .dashboard-container {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .dashboard-iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .feature-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.15);
        }
        .gradient-text {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header con branding corporativo -->
    <header class="company-branding">
        <div class="max-w-7xl mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold mb-1">Gobierno Digital e Innovaci√≥n</h1>
                    <p class="text-blue-100">Soluciones Tecnol√≥gicas para el Sector P√∫blico</p>
                </div>
                <div class="text-right mt-4 md:mt-0">
                    <p class="font-medium">Juan Heriberto Rosas</p>
                    <p class="text-blue-100 text-sm">Fundador y Director T√©cnico</p>
                    <p class="text-blue-100 text-sm">juanheriberto.rosas@gobiernodigitaleinnovacion.com</p>
                    <p class="text-blue-100 text-sm">Tel: 55-1080-6597 | Ciudad de M√©xico</p>
                    <a href="https://gobiernodigitaleinnovacion.com/" target="_blank" class="text-blue-100 underline text-sm hover:text-white">
                        www.gobiernodigitaleinnovacion.com
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto p-6">
        <!-- T√≠tulo principal -->
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold gradient-text mb-2">Sistema de An√°lisis Socioecon√≥mico</h2>
            <p class="text-xl text-gray-600">Encuesta Nacional de Ingresos y Gastos de los Hogares (ENIGH)</p>
            <p class="text-lg text-gray-500 mt-2">Instituto Nacional de Estad√≠stica y Geograf√≠a (INEGI)</p>
        </div>

        <!-- Pesta√±as de navegaci√≥n -->
        <div class="mb-6">
            <nav class="flex space-x-1 bg-gray-100 p-1 rounded-lg">
                <button id="tabAnalisis" class="flex-1 px-4 py-2 text-sm font-medium rounded-md bg-white text-blue-600 shadow-sm">
                    üìä Generador de An√°lisis
                </button>
                <button id="tabDashboard" class="flex-1 px-4 py-2 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700">
                    üìà Dashboard Interactivo
                </button>
                <button id="tabInfo" class="flex-1 px-4 py-2 text-sm font-medium rounded-md text-gray-500 hover:text-gray-700">
                    ‚ÑπÔ∏è Informaci√≥n
                </button>
            </nav>
        </div>

        <!-- Contenido de las pesta√±as -->
        
        <!-- Pesta√±a: Generador de An√°lisis -->
        <div id="contentAnalisis" class="tab-content">
            <!-- Mensaje de carga inicial -->
            <div id="loadingMessage" class="text-center py-8">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-600">Cargando datos desde Azure Blob Storage...</p>
            </div>

            <!-- Controles principales -->
            <div id="mainControls" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="feature-card bg-white p-6 rounded-lg shadow-md">
                        <label for="entidadSelect" class="block text-sm font-medium text-gray-700 mb-3">Entidad Federativa:</label>
                        <select id="entidadSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecciona una entidad</option>
                            <option value="TODAS">An√°lisis Nacional (Todas las entidades)</option>
                        </select>
                    </div>

                    <div class="feature-card bg-white p-6 rounded-lg shadow-md">
                        <label for="temaSelect" class="block text-sm font-medium text-gray-700 mb-3">Tema de An√°lisis:</label>
                        <select id="temaSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Selecciona un tema</option>
                            <option value="TODOS">üìä GENERAR TODOS LOS AN√ÅLISIS</option>
                            <option value="DEMOGRAFIA">Demograf√≠a y Estructura Poblacional</option>
                            <option value="INGRESOS">Distribuci√≥n de Ingresos y Desigualdad</option>
                            <option value="GASTOS">Patrones de Gasto y Consumo</option>
                            <option value="ALIMENTARIO">Seguridad Alimentaria y Nutrici√≥n</option>
                            <option value="BIENESTAR">Bienestar Socioecon√≥mico Integral</option>
                            <option value="VULNERABILIDAD">Vulnerabilidad y Exclusi√≥n Social</option>
                        </select>
                    </div>

                    <div class="feature-card bg-white p-6 rounded-lg shadow-md">
                        <div class="flex flex-col space-y-3">
                            <button id="startProcessButton" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                Generar An√°lisis
                            </button>
                            <button id="clearFiltersButton" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors text-sm">
                                üóëÔ∏è Limpiar Filtros
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Botones de control de proceso -->
                <div id="processControls" class="hidden text-center mb-6">
                    <button id="cancelProcessButton" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium mr-4 transition-colors">
                        Cancelar Proceso
                    </button>
                    <button id="pauseProcessButton" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium mr-4 transition-colors hidden">
                        Pausar Proceso
                    </button>
                    <button id="continueProcessButton" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium mr-4 transition-colors hidden">
                        Continuar Proceso
                    </button>
                    <button id="restartProcessButton" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition-colors hidden">
                        Reiniciar Proceso
                    </button>
                </div>

                <!-- Barra de progreso -->
                <div id="progressSection" class="hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium text-gray-700">Progreso del an√°lisis</span>
                                <span id="progressPercentage" class="text-sm text-gray-500">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="progressBarFill" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <p id="progressStatus" class="text-center text-gray-600 font-medium"></p>
                    </div>
                </div>

                <!-- Estado de datos -->
                <div id="dataStatus" class="mt-6 text-center">
                    <p id="fileStatus" class="text-green-600 font-medium hidden"></p>
                    <p id="errorStatus" class="text-red-600 font-medium hidden"></p>
                </div>
            </div>
        </div>

        <!-- Pesta√±a: Dashboard -->
        <div id="contentDashboard" class="tab-content hidden">
            <div class="dashboard-container">
                <div class="bg-white p-4 border-b">
                    <h3 class="text-xl font-bold text-gray-800">Dashboard Interactivo ENIGH 2024</h3>
                    <p class="text-gray-600">Visualizaciones avanzadas de datos socioecon√≥micos</p>
                </div>
                <iframe id="fabricDashboard" 
                        class="dashboard-iframe"
                        src="https://app.fabric.microsoft.com/view?r=eyJrIjoiNDMzNzgyYzItMjI5My00ZTdhLTllY2MtMmU5ZjkxMzE2OWYzIiwidCI6ImIwODMwZjgyLWM0OGQtNGU5ZC1iYTc0LTVlMjVmYmYzZmIzYiIsImMiOjR9"
                        allowfullscreen>
                </iframe>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="feature-card bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-lg font-bold text-gray-800 mb-3">üéØ Caracter√≠sticas del Dashboard</h4>
                    <ul class="text-gray-600 space-y-2">
                        <li>‚Ä¢ Visualizaciones interactivas de datos ENIGH 2024</li>
                        <li>‚Ä¢ Comparativas entre entidades federativas</li>
                        <li>‚Ä¢ An√°lisis de tendencias socioecon√≥micas</li>
                        <li>‚Ä¢ Filtros din√°micos por regi√≥n y tema</li>
                        <li>‚Ä¢ Indicadores clave de bienestar social</li>
                    </ul>
                </div>
                
                <div class="feature-card bg-white p-6 rounded-lg shadow-md">
                    <h4 class="text-lg font-bold text-gray-800 mb-3">üìä Herramientas Disponibles</h4>
                    <ul class="text-gray-600 space-y-2">
                        <li>‚Ä¢ Mapas interactivos por entidad</li>
                        <li>‚Ä¢ Gr√°ficos comparativos de ingresos y gastos</li>
                        <li>‚Ä¢ An√°lisis de seguridad alimentaria</li>
                        <li>‚Ä¢ Indicadores de vulnerabilidad social</li>
                        <li>‚Ä¢ Exportaci√≥n de reportes personalizados</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Pesta√±a: Informaci√≥n -->
        <div id="contentInfo" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Informaci√≥n de la empresa -->
                <div class="feature-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üè¢ Sobre Gobierno Digital e Innovaci√≥n</h3>
                    <div class="space-y-3">
                        <p class="text-gray-600">
                            Empresa especializada en el desarrollo de soluciones tecnol√≥gicas avanzadas para el sector p√∫blico, 
                            enfocada en la transformaci√≥n digital gubernamental y el an√°lisis de datos.
                        </p>
                        
                        <div class="border-t pt-3">
                            <h4 class="font-bold text-gray-700 mb-2">Contacto</h4>
                            <div class="space-y-1 text-sm">
                                <p><strong>Director:</strong> Juan Heriberto Rosas</p>
                                <p><strong>Email:</strong> 
                                    <a href="mailto:juanheriberto.rosas@gobiernodigitaleinnovacion.com" 
                                       class="text-blue-600 hover:underline">
                                        juanheriberto.rosas@gobiernodigitaleinnovacion.com
                                    </a>
                                </p>
                                <p><strong>Tel√©fono:</strong> 55-1080-6597</p>
                                <p><strong>Ubicaci√≥n:</strong> Ciudad de M√©xico, M√©xico</p>
                                <p><strong>Web:</strong> 
                                    <a href="https://gobiernodigitaleinnovacion.com/" target="_blank" 
                                       class="text-blue-600 hover:underline">
                                        www.gobiernodigitaleinnovacion.com
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n del sistema -->
                <div class="feature-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">‚öôÔ∏è Informaci√≥n del Sistema</h3>
                    <div class="space-y-3">
                        <div>
                            <h4 class="font-bold text-gray-700">Fuente de Datos</h4>
                            <p class="text-gray-600 text-sm">
                                Encuesta Nacional de Ingresos y Gastos de los Hogares (ENIGH) 2024 - INEGI
                            </p>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-gray-700">Tecnolog√≠as</h4>
                            <ul class="text-gray-600 text-sm space-y-1">
                                <li>‚Ä¢ Azure OpenAI para an√°lisis automatizado</li>
                                <li>‚Ä¢ Microsoft Fabric para dashboards</li>
                                <li>‚Ä¢ Azure Blob Storage para datos</li>
                                <li>‚Ä¢ JavaScript/HTML5 para interfaz</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 class="font-bold text-gray-700">Capacidades</h4>
                            <ul class="text-gray-600 text-sm space-y-1">
                                <li>‚Ä¢ An√°lisis automatizado por IA</li>
                                <li>‚Ä¢ Generaci√≥n de reportes PDF</li>
                                <li>‚Ä¢ Visualizaciones interactivas</li>
                                <li>‚Ä¢ Procesamiento de 32 entidades</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metodolog√≠a -->
            <div class="mt-6 feature-card bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üìã Metodolog√≠a de An√°lisis</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">1. Procesamiento de Datos</h4>
                        <p class="text-gray-600 text-sm">
                            Carga automatizada desde Azure Blob Storage con validaci√≥n de integridad y 
                            normalizaci√≥n de variables socioecon√≥micas.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">2. An√°lisis con IA</h4>
                        <p class="text-gray-600 text-sm">
                            Utilizaci√≥n de Azure OpenAI para generar an√°lisis cuantitativos especializados 
                            por tema y entidad federativa.
                        </p>
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-700 mb-2">3. Generaci√≥n de Reportes</h4>
                        <p class="text-gray-600 text-sm">
                            Creaci√≥n autom√°tica de documentos PDF profesionales con an√°lisis detallados 
                            y recomendaciones basadas en evidencia.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n Azure OpenAI
        const AZURE_OPENAI_API_KEY = CONFIG.AZURE_OPENAI_API_KEY;
        const AZURE_OPENAI_ENDPOINT = CONFIG.AZURE_OPENAI_ENDPOINT;
        const AZURE_OPENAI_API_VERSION = CONFIG.AZURE_OPENAI_API_VERSION;
        const AZURE_OPENAI_DEPLOYMENT_NAME = CONFIG.AZURE_OPENAI_DEPLOYMENT_NAME;

        // Informaci√≥n de la empresa para PDFs
        const COMPANY_INFO = {
            name: "Gobierno Digital e Innovaci√≥n",
            director: "Juan Heriberto Rosas",
            title: "Fundador y Director T√©cnico",
            email: "juanheriberto.rosas@gobiernodigitaleinnovacion.com",
            phone: "55-1080-6597",
            location: "Ciudad de M√©xico, M√©xico",
            website: "https://gobiernodigitaleinnovacion.com/"
        };

        // URL del archivo CSV en Azure Blob Storage
        const csvUrl = "https://stindicadores.blob.core.windows.net/indicadores/enigh_socioeconomico.csv?sp=rl&st=2024-10-22T16:42:42Z&se=2025-10-23T00:42:42Z&spr=https&sv=2022-11-02&sr=c&sig=JAeTGzwT%2FuwsBBHjN79AJnt3g%2BTqAq1FwXr5KD85D9k%3D";

        let data = [];
        let nationalData = [];
        let cancelProcess = false;
        let pauseProcess = false;
        let currentBatchProcess = null;
        let pendingAnalyses = [];
        let completedAnalyses = [];

        // Manejo de pesta√±as
        function initializeTabs() {
            const tabs = ['tabAnalisis', 'tabDashboard', 'tabInfo'];
            const contents = ['contentAnalisis', 'contentDashboard', 'contentInfo'];

            tabs.forEach((tabId, index) => {
                document.getElementById(tabId).addEventListener('click', () => {
                    // Remover clases activas de todas las pesta√±as
                    tabs.forEach(id => {
                        const tab = document.getElementById(id);
                        tab.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                        tab.classList.add('text-gray-500', 'hover:text-gray-700');
                    });

                    // Activar pesta√±a seleccionada
                    const activeTab = document.getElementById(tabId);
                    activeTab.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                    activeTab.classList.remove('text-gray-500', 'hover:text-gray-700');

                    // Mostrar/ocultar contenido
                    contents.forEach((contentId, contentIndex) => {
                        const content = document.getElementById(contentId);
                        if (contentIndex === index) {
                            content.classList.remove('hidden');
                        } else {
                            content.classList.add('hidden');
                        }
                    });
                });
            });
        }

        // Definici√≥n MEJORADA de variables por tema
        const TEMAS_VARIABLES = {
            'DEMOGRAFIA': {
                principales: ['poblacion_total', 'poblacion_hombres', 'poblacion_mujeres', 'pct_hombres', 'pct_mujeres'],
                hogares: ['total_hogares_expandidos', 'promedio_integrantes_hogar', 'hogares_jefe_hombre', 'hogares_jefe_mujer', 'promedio_edad_jefe'],
                ranking: ['ranking_poblacion'],
                contexto: ['municipios_representados', 'total_hogares_muestra', 'factor_expansion_promedio']
            },
            'INGRESOS': {
                principales: ['ingreso_corriente_promedio', 'ingreso_mediano', 'ingreso_total_estatal'],
                comparativos: ['indice_ingreso_vs_nacional', 'diferencia_ingreso_vs_nacional'],
                ranking: ['ranking_ingreso'],
                contexto: ['poblacion_total', 'total_hogares_expandidos']
            },
            'GASTOS': {
                principales: ['gasto_monetario_promedio', 'gasto_total_estatal'],
                comparativos: ['indice_gasto_vs_nacional', 'diferencia_gasto_vs_nacional'],
                ranking: ['ranking_gasto'],
                relaciones: ['ingreso_corriente_promedio', 'poblacion_total']
            },
            'ALIMENTARIO': {
                principales: ['gasto_alimentos_promedio'],
                detalle: ['gasto_carnes_promedio', 'gasto_cereales_promedio', 'gasto_verduras_promedio', 'gasto_leche_promedio', 'gasto_frutas_promedio', 'gasto_huevo_promedio'],
                seguridad: ['hogares_seguridad_alimentaria', 'hogares_inseguridad_severa', 'pct_seguridad_alimentaria', 'pct_inseguridad_severa'],
                contexto: ['gasto_monetario_promedio', 'ingreso_corriente_promedio']
            },
            'BIENESTAR': {
                economicos: ['ingreso_corriente_promedio', 'gasto_monetario_promedio', 'indice_ingreso_vs_nacional', 'indice_gasto_vs_nacional'],
                demograficos: ['poblacion_total', 'promedio_integrantes_hogar', 'promedio_edad_jefe'],
                alimentarios: ['pct_seguridad_alimentaria', 'gasto_alimentos_promedio'],
                rankings: ['ranking_poblacion', 'ranking_ingreso', 'ranking_gasto']
            },
            'VULNERABILIDAD': {
                principales: ['pct_inseguridad_severa', 'hogares_inseguridad_severa'],
                economicos: ['diferencia_ingreso_vs_nacional', 'diferencia_gasto_vs_nacional'],
                demograficos: ['hogares_jefe_mujer', 'promedio_edad_jefe'],
                contexto: ['ranking_ingreso', 'ranking_gasto', 'poblacion_total']
            }
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            initializeTabs();
            loadCSV();
        });

        document.getElementById('startProcessButton').addEventListener('click', startProcess);
        document.getElementById('cancelProcessButton').addEventListener('click', cancelCurrentProcess);
        document.getElementById('pauseProcessButton').addEventListener('click', pauseCurrentProcess);
        document.getElementById('continueProcessButton').addEventListener('click', continueCurrentProcess);
        document.getElementById('restartProcessButton').addEventListener('click', restartProcess);
        document.getElementById('clearFiltersButton').addEventListener('click', clearFilters);

        async function loadCSV() {
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`Error al cargar el archivo: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log("CSV cargado exitosamente:", results.data.length, "filas");
                        data = results.data.filter(row => 
                            row.nombre_entidad && 
                            row.poblacion_total !== null && 
                            row.poblacion_total !== undefined
                        );
                        
                        // Calcular datos nacionales para comparaciones
                        nationalData = calculateNationalAverages(data);
                        
                        console.log("Datos filtrados:", data.length, "filas");
                        populateEntidadDropdown();
                        
                        // Mostrar controles y ocultar loading
                        document.getElementById('loadingMessage').classList.add('hidden');
                        document.getElementById('mainControls').classList.remove('hidden');
                        document.getElementById('fileStatus').textContent = `Datos cargados: ${data.length} entidades federativas`;
                        document.getElementById('fileStatus').classList.remove('hidden');
                    },
                    error: function(error) {
                        console.error("Error al parsear CSV:", error);
                        showError("Error al procesar los datos del archivo CSV");
                    }
                });
            } catch (error) {
                console.error("Error al cargar CSV:", error);
                showError(`Error al cargar los datos: ${error.message}`);
            }
        }

        function calculateNationalAverages(data) {
            const totals = {};
            const numericFields = ['poblacion_total', 'ingreso_corriente_promedio', 'gasto_monetario_promedio', 
                                  'gasto_alimentos_promedio', 'pct_seguridad_alimentaria', 'pct_inseguridad_severa'];
            
            numericFields.forEach(field => {
                const values = data.map(row => row[field]).filter(val => val !== null && val !== undefined && !isNaN(val));
                totals[field + '_promedio'] = values.reduce((sum, val) => sum + val, 0) / values.length;
                totals[field + '_mediana'] = values.sort((a, b) => a - b)[Math.floor(values.length / 2)];
            });
            
            return totals;
        }

        function populateEntidadDropdown() {
            const entidadSelect = document.getElementById('entidadSelect');
            const entidades = [...new Set(data.map(row => row.nombre_entidad))].sort();
            
            entidades.forEach(entidad => {
                const option = document.createElement('option');
                option.value = entidad;
                option.textContent = entidad;
                entidadSelect.appendChild(option);
            });
        }

        function clearFilters() {
            document.getElementById('entidadSelect').value = '';
            document.getElementById('temaSelect').value = '';
            document.getElementById('fileStatus').textContent = `Datos cargados: ${data.length} entidades federativas`;
            document.getElementById('errorStatus').classList.add('hidden');
        }

        async function startProcess() {
            const selectedEntidad = document.getElementById('entidadSelect').value;
            const selectedTema = document.getElementById('temaSelect').value;

            if (!selectedEntidad || !selectedTema) {
                alert("Por favor, selecciona una entidad federativa y un tema de an√°lisis.");
                return;
            }

            try {
                cancelProcess = false;
                pauseProcess = false;
                completedAnalyses = [];
                
                // Mostrar controles de progreso
                document.getElementById('startProcessButton').classList.add('hidden');
                document.getElementById('processControls').classList.remove('hidden');
                document.getElementById('cancelProcessButton').classList.remove('hidden');
                document.getElementById('restartProcessButton').classList.add('hidden');
                document.getElementById('progressSection').classList.remove('hidden');
                
                // Si es "TODOS", preparar an√°lisis m√∫ltiples
                if (selectedTema === 'TODOS') {
                    await startBatchProcess(selectedEntidad);
                } else {
                    // Proceso individual normal
                    await startSingleProcess(selectedEntidad, selectedTema);
                }

            } catch (error) {
                console.error('Error en el proceso:', error);
                showError(`Error en el proceso: ${error.message}`);
            } finally {
                document.getElementById('cancelProcessButton').classList.add('hidden');
                document.getElementById('pauseProcessButton').classList.add('hidden');
                document.getElementById('continueProcessButton').classList.add('hidden');
                document.getElementById('restartProcessButton').classList.remove('hidden');
            }
        }

        async function startSingleProcess(selectedEntidad, selectedTema) {
            updateProgressBar(10, "Preparando datos para an√°lisis...");

            // Filtrar datos seg√∫n selecci√≥n
            let filteredData;
            if (selectedEntidad === 'TODAS') {
                filteredData = data;
            } else {
                filteredData = data.filter(row => row.nombre_entidad === selectedEntidad);
            }

            updateProgressBar(30, "Procesando an√°lisis con Azure OpenAI...");

            // Realizar an√°lisis
            const analysis = await analyzeWithAzureOpenAI(selectedTema, filteredData, selectedEntidad);
            
            updateProgressBar(80, "Generando documento PDF...");

            // Generar PDF
            await generatePDF(selectedTema, analysis, selectedEntidad);
            
            updateProgressBar(100, "Proceso completado exitosamente");
        }

        async function startBatchProcess(selectedEntidad) {
            const allTemas = ['DEMOGRAFIA', 'INGRESOS', 'GASTOS', 'ALIMENTARIO', 'BIENESTAR', 'VULNERABILIDAD'];
            const temaNames = {
                'DEMOGRAFIA': 'Demograf√≠a y Estructura Poblacional',
                'INGRESOS': 'Distribuci√≥n de Ingresos y Desigualdad',
                'GASTOS': 'Patrones de Gasto y Consumo',
                'ALIMENTARIO': 'Seguridad Alimentaria y Nutrici√≥n',
                'BIENESTAR': 'Bienestar Socioecon√≥mico Integral',
                'VULNERABILIDAD': 'Vulnerabilidad y Exclusi√≥n Social'
            };

            pendingAnalyses = allTemas.map(tema => ({
                entidad: selectedEntidad,
                tema: tema,
                nombreTema: temaNames[tema]
            }));

            completedAnalyses = [];
            const totalAnalyses = pendingAnalyses.length;

            // Mostrar bot√≥n de pausa para an√°lisis m√∫ltiples
            document.getElementById('pauseProcessButton').classList.remove('hidden');

            updateProgressBar(0, `Iniciando an√°lisis m√∫ltiple: ${totalAnalyses} temas para ${selectedEntidad === 'TODAS' ? 'an√°lisis nacional' : selectedEntidad}`);

            await processBatchAnalyses(totalAnalyses);
        }

        async function processBatchAnalyses(totalAnalyses) {
            while (pendingAnalyses.length > 0 && !cancelProcess) {
                if (pauseProcess) {
                    document.getElementById('pauseProcessButton').classList.add('hidden');
                    document.getElementById('continueProcessButton').classList.remove('hidden');
                    updateProgressBar(
                        (completedAnalyses.length / totalAnalyses) * 100, 
                        `Proceso pausado. Completados: ${completedAnalyses.length}/${totalAnalyses}`
                    );
                    return; // Salir del bucle cuando est√° pausado
                }

                const currentAnalysis = pendingAnalyses.shift();
                const progressPercent = (completedAnalyses.length / totalAnalyses) * 100;
                
                updateProgressBar(
                    progressPercent, 
                    `Procesando: ${currentAnalysis.nombreTema} (${completedAnalyses.length + 1}/${totalAnalyses})`
                );

                try {
                    // Filtrar datos seg√∫n selecci√≥n
                    let filteredData;
                    if (currentAnalysis.entidad === 'TODAS') {
                        filteredData = data;
                    } else {
                        filteredData = data.filter(row => row.nombre_entidad === currentAnalysis.entidad);
                    }

                    // Realizar an√°lisis
                    const analysis = await analyzeWithAzureOpenAI(currentAnalysis.tema, filteredData, currentAnalysis.entidad);
                    
                    // Generar PDF
                    await generatePDF(currentAnalysis.tema, analysis, currentAnalysis.entidad);
                    
                    completedAnalyses.push(currentAnalysis);

                    // Peque√±a pausa para permitir la descarga del PDF
                    await new Promise(resolve => setTimeout(resolve, 2000));

                    // Actualizar progreso sin modal
                    const newProgressPercent = (completedAnalyses.length / totalAnalyses) * 100;
                    updateProgressBar(
                        newProgressPercent,
                        `‚úÖ Completado: ${currentAnalysis.nombreTema} (${completedAnalyses.length}/${totalAnalyses})`
                    );

                } catch (error) {
                    console.error(`Error procesando ${currentAnalysis.nombreTema}:`, error);
                    
                    // Preguntar si contin√∫a con el siguiente
                    const shouldContinue = confirm(`Error procesando "${currentAnalysis.nombreTema}": ${error.message}\n\n¬øDeseas continuar con el siguiente an√°lisis?`);
                    if (!shouldContinue) {
                        break;
                    }
                }
            }

            // Proceso completado
            if (!cancelProcess && !pauseProcess) {
                updateProgressBar(100, `üéâ Proceso completado: ${completedAnalyses.length}/${totalAnalyses} an√°lisis generados exitosamente`);
                document.getElementById('pauseProcessButton').classList.add('hidden');
            }
        }

        function pauseCurrentProcess() {
            pauseProcess = true;
            document.getElementById('pauseProcessButton').classList.add('hidden');
            document.getElementById('continueProcessButton').classList.remove('hidden');
            updateProgressBar(
                (completedAnalyses.length / (completedAnalyses.length + pendingAnalyses.length)) * 100,
                `Proceso pausado por el usuario. Completados: ${completedAnalyses.length}`
            );
        }

        async function continueCurrentProcess() {
            pauseProcess = false;
            document.getElementById('pauseProcessButton').classList.remove('hidden');
            document.getElementById('continueProcessButton').classList.add('hidden');
            
            const totalAnalyses = completedAnalyses.length + pendingAnalyses.length;
            await processBatchAnalyses(totalAnalyses);
        }

        function cancelCurrentProcess() {
            cancelProcess = true;
            pauseProcess = false;
            pendingAnalyses = [];
            
            updateProgressBar(0, "Proceso cancelado por el usuario");
            document.getElementById('cancelProcessButton').classList.add('hidden');
            document.getElementById('pauseProcessButton').classList.add('hidden');
            document.getElementById('continueProcessButton').classList.add('hidden');
            document.getElementById('restartProcessButton').classList.remove('hidden');
        }

        function restartProcess() {
            cancelProcess = false;
            pauseProcess = false;
            pendingAnalyses = [];
            completedAnalyses = [];
            
            document.getElementById('startProcessButton').classList.remove('hidden');
            document.getElementById('processControls').classList.add('hidden');
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('errorStatus').classList.add('hidden');
            updateProgressBar(0, "");
        }

        function updateProgressBar(percentage, status) {
            document.getElementById('progressBarFill').style.width = `${percentage}%`;
            document.getElementById('progressPercentage').textContent = `${Math.round(percentage)}%`;
            document.getElementById('progressStatus').textContent = status;
        }

        function showError(message) {
            document.getElementById('errorStatus').textContent = message;
            document.getElementById('errorStatus').classList.remove('hidden');
        }

        async function analyzeWithAzureOpenAI(tema, filteredData, selectedEntidad) {
            const temaNames = {
                'DEMOGRAFIA': 'Demograf√≠a y Estructura Poblacional',
                'INGRESOS': 'Distribuci√≥n de Ingresos y Desigualdad',
                'GASTOS': 'Patrones de Gasto y Consumo',
                'ALIMENTARIO': 'Seguridad Alimentaria y Nutrici√≥n',
                'BIENESTAR': 'Bienestar Socioecon√≥mico Integral',
                'VULNERABILIDAD': 'Vulnerabilidad y Exclusi√≥n Social'
            };

            // Obtener variables relevantes para el tema
            const temaVars = TEMAS_VARIABLES[tema];
            const allRelevantVars = Object.values(temaVars).flat();
            
            // Filtrar datos con variables relevantes
            const dataForAnalysis = filteredData.map(row => {
                const filteredRow = { nombre_entidad: row.nombre_entidad };
                allRelevantVars.forEach(variable => {
                    filteredRow[variable] = row[variable];
                });
                return filteredRow;
            });

            const scopeText = selectedEntidad === 'TODAS' ? 
                'las 32 entidades federativas de M√©xico' : 
                `la entidad federativa de ${selectedEntidad}`;

            const prompt = `
Eres un analista senior del INEGI especializado en an√°lisis socioecon√≥mico cuantitativo. Analiza estos datos ENIGH para ${scopeText}:

TEMA: ${temaNames[tema]}

DATOS ESPEC√çFICOS:
${JSON.stringify(dataForAnalysis, null, 2)}

DATOS NACIONALES DE REFERENCIA:
${JSON.stringify(nationalData, null, 2)}

INSTRUCCIONES CR√çTICAS:

1. FORMATO DE TEXTO OBLIGATORIO:
- Usa SOLO texto plano, SIN formato Markdown
- NO uses ** para negritas, NO uses # para t√≠tulos
- NO uses s√≠mbolos matem√°ticos especiales (evita \[ \] \$)
- Presenta n√∫meros con formato mexicano: 123,456.78 pesos
- Usa porcentajes simples: 23.5% (sin s√≠mbolos especiales)

2. AN√ÅLISIS CUANTITATIVO ESPEC√çFICO:
${selectedEntidad === 'TODAS' ? 
`- Identifica exactamente los 3 estados con mejores y 3 con peores indicadores
- Calcula percentiles precisos (P25, P50, P75) para variables principales
- Determina coeficientes de variaci√≥n exactos
- Identifica valores at√≠picos con cifras espec√≠ficas` :
`- Compara TODOS los indicadores num√©ricos con datos nacionales exactos
- Calcula la posici√≥n percentil precisa de la entidad
- Determina brechas en n√∫meros absolutos y porcentajes exactos
- Eval√∫a rankings con posiciones num√©ricas espec√≠ficas`}

3. C√ÅLCULOS Y RELACIONES OBLIGATORIAS:
- Calcula ratios importantes: gasto/ingreso, alimentos/gasto total
- Presenta correlaciones entre variables principales
- Identifica tendencias con cifras de variaci√≥n espec√≠ficas
- Analiza brechas de desigualdad con n√∫meros exactos

4. VALIDACI√ìN DE DATOS:
- Verifica coherencia entre variables relacionadas
- Asegura que los c√°lculos sean matem√°ticamente correctos
- Compara solo con datos nacionales proporcionados
- Evita especulaciones sin respaldo num√©rico

5. ESTRUCTURA ANAL√çTICA:
${tema === 'DEMOGRAFIA' ? 'Analiza: distribuci√≥n por sexo (cifras exactas), estructura de hogares (tama√±o promedio), jefatura (porcentajes espec√≠ficos), comparaciones poblacionales precisas' :
  tema === 'INGRESOS' ? 'Analiza: ingresos corriente vs mediano (diferencias exactas), brechas vs promedio nacional (pesos y porcentajes), posici√≥n en rankings, distribuci√≥n y desigualdad' :
  tema === 'GASTOS' ? 'Analiza: gasto monetario (cifras exactas), propensi√≥n al consumo (ratios), comparaciones regionales, relaci√≥n gasto-ingreso espec√≠fica' :
  tema === 'ALIMENTARIO' ? 'Analiza: gasto por categor√≠as alimentarias (porcentajes del total), seguridad alimentaria (cifras precisas), diversidad diet√©tica, relaci√≥n con capacidad econ√≥mica' :
  tema === 'BIENESTAR' ? 'Analiza: √≠ndice multidimensional (combinando variables), consistencia entre indicadores, posici√≥n integral vs nacional' :
  'Analiza: vulnerabilidad m√∫ltiple (intersecci√≥n de carencias), grupos en riesgo (cifras espec√≠ficas), factores de exclusi√≥n cuantificados'}

6. CONCLUSIONES CON EVIDENCIA:
- Presenta 5 hallazgos clave con cifras espec√≠ficas de respaldo
- Identifica mensajes principales basados en n√∫meros exactos
- Propone hip√≥tesis con justificaci√≥n cuantitativa
- Evita recomendaciones gen√©ricas sin base num√©rica

FORMATO OBLIGATORIO:
- P√°rrafos descriptivos SIN t√≠tulos especiales
- Cifras exactas con comas para miles: 123,456 pesos
- Porcentajes con 1 decimal: 23.5%
- Rankings y posiciones num√©ricas espec√≠ficas
- Comparaciones cuantitativas precisas

PROHIBIDO:
- Metodolog√≠a ENIGH extensa (m√°ximo 2 l√≠neas)
- Recomendaciones de pol√≠tica p√∫blica gen√©ricas
- Texto sin cifras espec√≠ficas de respaldo
- S√≠mbolos matem√°ticos o formato Markdown
- Generalidades sin datos cuantitativos espec√≠ficos
`;

            try {
                console.log(`Iniciando an√°lisis cuantitativo para tema: ${tema}, √°mbito: ${selectedEntidad}`);

                const response = await fetch(`${AZURE_OPENAI_ENDPOINT}/openai/deployments/${AZURE_OPENAI_DEPLOYMENT_NAME}/chat/completions?api-version=${AZURE_OPENAI_API_VERSION}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'api-key': AZURE_OPENAI_API_KEY
                    },
                    body: JSON.stringify({
                        messages: [
                            { role: "system", content: "Eres un analista cuantitativo senior del INEGI. PROHIBIDO usar formato Markdown (**texto**) o s√≠mbolos matem√°ticos especiales. SOLO texto plano con cifras espec√≠ficas. Enf√≥cate en an√°lisis num√©rico preciso." },
                            { role: "user", content: prompt }
                        ],
                        max_completion_tokens: 4500,
                        temperature: 0.2
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Error HTTP ${response.status}: ${errorText}`);
                    throw new Error(`Error en la API: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log(`An√°lisis completado para tema: ${tema}`);
                
                // Limpiar formato Markdown residual
                let cleanAnalysis = result.choices[0].message.content.trim();
                cleanAnalysis = cleanAnalysis.replace(/\*\*(.*?)\*\*/g, '$1'); // Quitar **texto**
                cleanAnalysis = cleanAnalysis.replace(/\*(.*?)\*/g, '$1'); // Quitar *texto*
                cleanAnalysis = cleanAnalysis.replace(/\\\[(.*?)\\\]/g, '$1'); // Quitar \[formula\]
                cleanAnalysis = cleanAnalysis.replace(/\\\$(.*?)\\\$/g, '$1'); // Quitar \$formula\$
                cleanAnalysis = cleanAnalysis.replace(/#{1,6}\s+/g, ''); // Quitar ### t√≠tulos
                cleanAnalysis = cleanAnalysis.replace(/\n\s*\n\s*\n/g, '\n\n'); // Normalizar espacios
                
                return cleanAnalysis;

            } catch (error) {
                console.error('Error en an√°lisis Azure OpenAI:', error);
                throw new Error(`Error al generar el an√°lisis: ${error.message}`);
            }
        }

        async function generatePDF(tema, analysis, selectedEntidad) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const temaNames = {
                'DEMOGRAFIA': 'Demografia_y_Estructura_Poblacional',
                'INGRESOS': 'Distribucion_de_Ingresos_y_Desigualdad',
                'GASTOS': 'Patrones_de_Gasto_y_Consumo',
                'ALIMENTARIO': 'Seguridad_Alimentaria_y_Nutricion',
                'BIENESTAR': 'Bienestar_Socioeconomico_Integral',
                'VULNERABILIDAD': 'Vulnerabilidad_y_Exclusion_Social'
            };

            const scopeName = selectedEntidad === 'TODAS' ? 'Nacional' : selectedEntidad.replace(/\s+/g, '_');
            const fileName = `ENIGH_${temaNames[tema]}_${scopeName}.pdf`;

            // Configuraci√≥n de p√°gina
            const margin = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const contentWidth = pageWidth - 2 * margin;

            // Funci√≥n para a√±adir nueva p√°gina
            const addNewPage = () => {
                doc.addPage();
                return margin;
            };

            // HEADER CORPORATIVO MEJORADO
            doc.setFillColor(30, 64, 175); // Color azul corporativo
            doc.rect(0, 0, pageWidth, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text("GOBIERNO DIGITAL E INNOVACI√ìN", margin, 15);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text("Soluciones Tecnol√≥gicas para el Sector P√∫blico", margin, 23);
            doc.text(`${COMPANY_INFO.website}`, margin, 29);

            // Informaci√≥n de contacto en header
            doc.text(`${COMPANY_INFO.director} | ${COMPANY_INFO.phone}`, pageWidth - margin, 15, { align: 'right' });
            doc.text(`${COMPANY_INFO.email}`, pageWidth - margin, 21, { align: 'right' });
            doc.text(`${COMPANY_INFO.location}`, pageWidth - margin, 27, { align: 'right' });

            // T√≠tulo del an√°lisis
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            const title = "AN√ÅLISIS SOCIOECON√ìMICO ENIGH 2024";
            doc.text(title, pageWidth / 2, 50, { align: 'center' });

            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            const temaDisplayNames = {
                'DEMOGRAFIA': 'Demograf√≠a y Estructura Poblacional',
                'INGRESOS': 'Distribuci√≥n de Ingresos y Desigualdad',
                'GASTOS': 'Patrones de Gasto y Consumo',
                'ALIMENTARIO': 'Seguridad Alimentaria y Nutrici√≥n',
                'BIENESTAR': 'Bienestar Socioecon√≥mico Integral',
                'VULNERABILIDAD': 'Vulnerabilidad y Exclusi√≥n Social'
            };
            const subtitle = temaDisplayNames[tema];
            doc.text(subtitle, pageWidth / 2, 58, { align: 'center' });

            doc.setFontSize(12);
            const scope = selectedEntidad === 'TODAS' ? 'An√°lisis Nacional' : selectedEntidad;
            doc.text(scope, pageWidth / 2, 66, { align: 'center' });

            // L√≠nea separadora
            doc.setDrawColor(100, 100, 100);
            doc.line(margin, 75, pageWidth - margin, 75);

            // Contenido del an√°lisis
            let yPosition = 85;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');

            // Dividir en p√°rrafos y procesar
            const paragraphs = analysis.split('\n\n').filter(p => p.trim().length > 0);

            paragraphs.forEach((paragraph, index) => {
                // Verificar si necesitamos nueva p√°gina
                if (yPosition > pageHeight - margin * 3) {
                    yPosition = addNewPage();
                    yPosition += 10;
                }

                const lines = doc.splitTextToSize(paragraph.trim(), contentWidth);
                
                lines.forEach(line => {
                    if (yPosition > pageHeight - margin * 2) {
                        yPosition = addNewPage();
                        yPosition += 10;
                    }
                    doc.text(line, margin, yPosition);
                    yPosition += 5;
                });

                // Espacio entre p√°rrafos
                yPosition += 3;
            });

            // PIE DE P√ÅGINA CORPORATIVO EN TODAS LAS P√ÅGINAS
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                
                // L√≠nea separadora del pie
                doc.setDrawColor(100, 100, 100);
                doc.line(margin, pageHeight - 25, pageWidth - margin, pageHeight - 25);
                
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(80, 80, 80);
                
                // Informaci√≥n fuente y fecha
                doc.text("Fuente: INEGI - Encuesta Nacional de Ingresos y Gastos de los Hogares (ENIGH) 2024", margin, pageHeight - 18);
                doc.text(`Generado: ${new Date().toLocaleDateString('es-MX')} | P√°gina ${i} de ${totalPages}`, pageWidth - margin, pageHeight - 18, { align: 'right' });
                
                // Informaci√≥n corporativa en pie
                doc.text(`${COMPANY_INFO.name} | ${COMPANY_INFO.director}`, margin, pageHeight - 12);
                doc.text(`Dashboard disponible: https://app.fabric.microsoft.com/view?r=eyJrIjoiNDMzNzgyYzItMjI5My00ZTdhLTllY2MtMmU5ZjkxMzE2OWYzIiwidCI6ImIwODMwZjgyLWM0OGQtNGU5ZC1iYTc0LTVlMjVmYmYzZmIzYiIsImMiOjR9`, margin, pageHeight - 8);
            }

            // Descargar PDF
            doc.save(fileName);
            console.log(`PDF generado: ${fileName}`);
        }
    </script>
</body>
</html>
